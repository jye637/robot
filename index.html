import React, { useState, useEffect } from 'react';
import { Play, RotateCcw, ArrowUp, ArrowLeft, ArrowRight, Star, Camera, RefreshCw, Trophy, AlertCircle, ChevronRight, Home } from 'lucide-react';

// --- Constants & Config ---
const SCHOOL_NAME = "é«˜é›„å¸‚è”¡æ–‡åœ‹å°";
const GAME_TITLE = "Canva AI é«”é©—ï¼šå°å°ç¨‹å¼è¨­è¨ˆå¸«";

// --- Level Configuration ---
const LEVELS = [
  {
    id: 1,
    name: "åˆç´šï¼šæš–èº«ç·´ç¿’",
    description: "ç†Ÿæ‚‰æ©Ÿå™¨äººæ“ä½œï¼Œèµ°å‡ºç¬¬ä¸€æ­¥ï¼",
    gridSize: 3,
    // 0: Path, 1: Wall, 2: Start, 3: Goal
    layout: [
      [2, 0, 1],
      [1, 0, 3],
      [1, 1, 1]
    ],
    start: { x: 0, y: 0, dir: 1 }, // Facing East
    goal: { x: 2, y: 1 },
    maxCommands: 10,
    certTitle: "æˆ‘æœƒæ§åˆ¶æ©Ÿå™¨äºº",
    certColor: "text-blue-500"
  },
  {
    id: 2,
    name: "ä¸­ç´šï¼šè¿·å®®æ¢éšª",
    description: "è·¯è®Šé•·äº†ï¼Œå°å¿ƒä¸è¦æ’åˆ°ç‰†å£å–”ï¼",
    gridSize: 4,
    layout: [
      [2, 0, 0, 1],
      [1, 1, 0, 1],
      [0, 0, 0, 0],
      [0, 1, 1, 3]
    ],
    start: { x: 0, y: 0, dir: 1 }, // Facing East
    goal: { x: 3, y: 3 },
    maxCommands: 15,
    certTitle: "ç¨‹å¼æ¢éšªå®¶",
    certColor: "text-purple-500"
  },
  {
    id: 3,
    name: "é«˜ç´šï¼šå¤§å¸«æŒ‘æˆ°",
    description: "è¤‡é›œçš„è¿·å®®ï¼é€™æ˜¯çµ¦äº”å¹´ç´šé«˜æ‰‹çš„æŒ‘æˆ°ï¼",
    gridSize: 5,
    layout: [
      [1, 3, 0, 0, 1],
      [1, 1, 1, 0, 1],
      [0, 0, 0, 0, 1],
      [0, 1, 1, 1, 1],
      [2, 0, 0, 0, 0]
    ],
    start: { x: 0, y: 4, dir: 1 }, // Facing East
    goal: { x: 1, y: 0 },
    maxCommands: 20,
    certTitle: "ç¨‹å¼è¨­è¨ˆå¤§å¸«",
    certColor: "text-yellow-500"
  }
];

// --- Components ---

const RobotIcon = ({ className, mood = "happy" }) => (
  <svg viewBox="0 0 100 100" className={className}>
    <style>{`
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      .animate-shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite;
      }
    `}</style>
    <g className={mood === "dance" ? "animate-bounce" : mood === "shake" ? "animate-shake" : ""}>
      
      {/* é ­é ‚ç®­é ­: ç´…è‰² (#EF4444) */}
      <polygon points="45,15 55,15 50,5" fill="#EF4444" stroke="black" strokeWidth="2" className="drop-shadow-sm" />

      {/* Antennas */}
      <line x1="30" y1="20" x2="20" y2="10" stroke="#374151" strokeWidth="4" />
      <circle cx="20" cy="10" r="4" fill={mood === "error" ? "#EF4444" : "#EF4444"} />
      <line x1="70" y1="20" x2="80" y2="10" stroke="#374151" strokeWidth="4" />
      <circle cx="80" cy="10" r="4" fill={mood === "error" ? "#EF4444" : "#EF4444"} />
      
      {/* Head */}
      <rect x="25" y="20" width="50" height="40" rx="10" 
        fill={mood === "error" ? "#FCA5A5" : "#60A5FA"} 
        stroke={mood === "error" ? "#DC2626" : "#2563EB"} 
        strokeWidth="3" 
      />
      
      {/* Eyes */}
      <circle cx="40" cy="35" r="5" fill="white" />
      <circle cx="40" cy="35" r="2" fill="black" />
      <circle cx="60" cy="35" r="5" fill="white" />
      <circle cx="60" cy="35" r="2" fill="black" />

      {/* Mouth */}
      {mood === "sad" || mood === "error" ? (
        <path d="M 40 50 Q 50 45 60 50" stroke="white" strokeWidth="3" fill="none" />
      ) : (
        <path d="M 40 45 Q 50 55 60 45" stroke="white" strokeWidth="3" fill="none" />
      )}

      {/* Body */}
      <rect x="30" y="65" width="40" height="30" rx="5" 
        fill={mood === "error" ? "#FCA5A5" : "#A78BFA"} 
        stroke={mood === "error" ? "#DC2626" : "#7C3AED"} 
        strokeWidth="3" 
      />
      
      {/* Details */}
      <circle cx="50" cy="80" r="8" fill="#FCD34D" />
      
      {/* Crash marks if error */}
      {mood === "error" && (
        <path d="M 20 20 L 40 40 M 80 20 L 60 40" stroke="#DC2626" strokeWidth="4" strokeLinecap="round" />
      )}
    </g>
  </svg>
);

export default function App() {
  const [page, setPage] = useState(1);
  const [currentLevelIndex, setCurrentLevelIndex] = useState(0); // 0, 1, 2
  const [commands, setCommands] = useState([]);
  const [robotState, setRobotState] = useState(LEVELS[0].start);
  const [executionStep, setExecutionStep] = useState(-1);
  const [isAnimating, setIsAnimating] = useState(false);
  const [errorIndex, setErrorIndex] = useState(-1);

  const currentLevel = LEVELS[currentLevelIndex];

  // å®Œå…¨é‡ç½®å›é¦–é 
  const resetGameFull = () => {
    setCommands([]);
    setCurrentLevelIndex(0);
    setRobotState(LEVELS[0].start);
    setExecutionStep(-1);
    setIsAnimating(false);
    setErrorIndex(-1);
    setPage(1);
  };

  // é‡ç½®ç•¶å‰é—œå¡
  const resetLevel = () => {
    setCommands([]);
    setRobotState(currentLevel.start);
    setExecutionStep(-1);
    setIsAnimating(false);
    setErrorIndex(-1);
  };

  // é€²å…¥ä¸‹ä¸€é—œ
  const nextLevel = () => {
    if (currentLevelIndex < LEVELS.length - 1) {
      const nextIdx = currentLevelIndex + 1;
      setCurrentLevelIndex(nextIdx);
      setCommands([]);
      setRobotState(LEVELS[nextIdx].start);
      setExecutionStep(-1);
      setIsAnimating(false);
      setErrorIndex(-1);
      setPage(3); // Go to game page
    } else {
      // å·²ç¶“æ˜¯æœ€å¾Œä¸€é—œï¼Œå›åˆ°é¦–é æˆ–é¡¯ç¤ºæœ€çµ‚ç•«é¢
      resetGameFull();
    }
  };

  const addCommand = (cmd) => {
    if (commands.length < currentLevel.maxCommands) {
      setCommands([...commands, cmd]);
    }
  };

  const removeCommand = (index) => {
    if (!isAnimating) {
      const newCmds = [...commands];
      newCmds.splice(index, 1);
      setCommands(newCmds);
    }
  };

  const runSimulation = async () => {
    if (commands.length === 0) return;
    setIsAnimating(true);
    setExecutionStep(0);
    setErrorIndex(-1);
    setRobotState(currentLevel.start);
  };

  // Execution Logic
  useEffect(() => {
    if (executionStep >= 0 && executionStep < commands.length && errorIndex === -1) {
      
      // é˜²æ­¢å› ç‚º React ç‹€æ…‹æ›´æ–°å°è‡´é‡è¤‡åŸ·è¡Œæœ€å¾Œä¸€æ­¥
      if (robotState.x === currentLevel.goal.x && robotState.y === currentLevel.goal.y) {
        return;
      }

      const timer = setTimeout(() => {
        const cmd = commands[executionStep];
        let nextState = { ...robotState };

        if (cmd === 'F') {
          if (nextState.dir === 0) nextState.y -= 1; // North
          if (nextState.dir === 1) nextState.x += 1; // East
          if (nextState.dir === 2) nextState.y += 1; // South
          if (nextState.dir === 3) nextState.x -= 1; // West
        } else if (cmd === 'L') {
          nextState.dir = (nextState.dir - 1 + 4) % 4;
        } else if (cmd === 'R') {
          nextState.dir = (nextState.dir + 1) % 4;
        }

        // --- é‚Šç•Œèˆ‡ç¢°æ’æª¢æŸ¥ ---
        const isOutOfBounds = nextState.x < 0 || nextState.x >= currentLevel.gridSize || 
                              nextState.y < 0 || nextState.y >= currentLevel.gridSize;

        let isWall = false;
        if (!isOutOfBounds) {
          if (currentLevel.layout[nextState.y][nextState.x] === 1) {
            isWall = true;
          }
        }

        if (isWall || isOutOfBounds) {
          // ç¢°æ’éŒ¯èª¤!
          setErrorIndex(executionStep);
          setTimeout(() => {
            setPage(4);
            setIsAnimating(false);
          }, 2000);
        } else {
          // æœ‰æ•ˆç§»å‹•
          setRobotState(nextState);
          
          // æª¢æŸ¥å‹åˆ©æ¢ä»¶
          if (nextState.x === currentLevel.goal.x && nextState.y === currentLevel.goal.y) {
            // åˆ°é”çµ‚é»
            setTimeout(() => {
              setPage(5); // æˆåŠŸé é¢
              setIsAnimating(false);
            }, 1000);
          } else {
            // é‚„æœ‰æŒ‡ä»¤è¦åŸ·è¡Œ
            if (executionStep + 1 < commands.length) {
              setExecutionStep(prev => prev + 1);
            } else {
              // æŒ‡ä»¤åŸ·è¡Œå®Œç•¢ï¼Œä½†æœªåˆ°é”çµ‚é»
              setTimeout(() => {
                setPage(4); // å¤±æ•—é é¢
                setIsAnimating(false);
              }, 1000);
            }
          }
        }
      }, 800);
      return () => clearTimeout(timer);
    }
  }, [executionStep, commands, robotState, errorIndex, currentLevel]);


  // --- Pages ---

  // Page 1: Cover
  if (page === 1) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-500 via-indigo-600 to-purple-700 flex flex-col items-center justify-center p-4 text-white font-sans">
        <div className="bg-white/10 backdrop-blur-md p-8 rounded-3xl shadow-2xl flex flex-col items-center text-center max-w-md w-full border border-white/20">
          <div className="bg-blue-100 p-4 rounded-full mb-6 animate-bounce">
            <RobotIcon className="w-32 h-32" />
          </div>
          <h1 className="text-3xl md:text-4xl font-bold mb-2 tracking-tight text-yellow-300 drop-shadow-md">
            {GAME_TITLE}
          </h1>
          <h2 className="text-xl mb-8 font-light tracking-widest bg-blue-800/50 px-4 py-1 rounded-full">
            {SCHOOL_NAME}
          </h2>
          
          <div className="space-y-3 w-full">
            <button 
              onClick={() => { setCurrentLevelIndex(0); setPage(2); }}
              className="group relative px-8 py-4 bg-yellow-400 hover:bg-yellow-300 text-blue-900 font-black text-xl rounded-2xl shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-1 transition-all w-full"
            >
              é–‹å§‹å†’éšª
              <span className="absolute right-4 top-1/2 -translate-y-1/2 group-hover:translate-x-1 transition-transform">
                <Play fill="currentColor" size={24} />
              </span>
            </button>
          </div>
        </div>
        <p className="mt-8 text-white/60 text-sm">Design for Kids Coding Education</p>
      </div>
    );
  }

  // Page 2: Instructions (åªåœ¨ç¬¬ä¸€é—œå‰é¡¯ç¤ºï¼Œæˆ–å¯é€šç”¨)
  if (page === 2) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-400 to-purple-500 flex flex-col items-center justify-center p-4">
        <div className="bg-white rounded-3xl shadow-xl p-8 max-w-lg w-full relative overflow-hidden">
          <div className="absolute top-0 left-0 w-full h-4 bg-yellow-400"></div>
          <h2 className="text-3xl font-bold text-blue-800 mb-6 text-center">æ€éº¼å¹«æˆ‘ï¼Ÿ</h2>
          
          <div className="space-y-4 mb-8">
            <div className="flex items-center bg-blue-50 p-3 rounded-xl">
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4 text-2xl">ğŸ¤–</div>
              <p className="text-gray-700 font-bold">å—¨ï¼æˆ‘è¿·è·¯äº†ï¼Œè«‹å¹«æˆ‘æ‰¾åˆ°æ˜Ÿæ˜Ÿï¼</p>
            </div>
            <div className="flex items-center bg-purple-50 p-3 rounded-xl">
              <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mr-4">
                <ArrowUp className="text-purple-600" />
              </div>
              <p className="text-gray-600">ç”¨æŒ‡ä»¤å¡ç‰‡å‘Šè¨´æˆ‘è©²æ€éº¼èµ°ã€‚</p>
            </div>
            {currentLevelIndex === 0 && (
              <div className="flex items-start bg-yellow-50 p-3 rounded-xl border border-yellow-200">
                <div className="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center mr-4">
                  <Trophy className="text-yellow-600" />
                </div>
                <div className="text-gray-600 text-left">
                  <p className="font-bold text-gray-700">æ–°æ‰‹æç¤º</p>
                  <p className="text-xs mt-1">
                    è¨˜å¾—ï¼ã€Œå·¦è½‰ã€å’Œã€Œå³è½‰ã€æ˜¯æ”¹è®Šæ©Ÿå™¨äººé¢å°çš„æ–¹å‘ï¼Œä¸æ˜¯ç›´æ¥æ©«è‘—èµ°å–”ï¼
                  </p>
                </div>
              </div>
            )}
          </div>

          <button 
            onClick={() => { resetLevel(); setPage(3); }}
            className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold text-xl rounded-xl shadow-lg transition-colors"
          >
            æˆ‘æº–å‚™å¥½äº†ï¼
          </button>
        </div>
      </div>
    );
  }

  // Page 3: The Game
  if (page === 3) {
    return (
      <div className="min-h-screen bg-slate-100 flex flex-col items-center p-4 md:p-8">
        {/* Header */}
        <div className="w-full max-w-4xl flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
          <div className="flex items-center gap-3">
             <div className={`
               px-4 py-1.5 rounded-full text-white font-bold text-sm shadow-sm
               ${currentLevel.id === 1 ? 'bg-blue-500' : currentLevel.id === 2 ? 'bg-purple-500' : 'bg-yellow-500'}
             `}>
               Level {currentLevel.id}
             </div>
             <div>
               <h2 className="text-xl font-bold text-slate-800">{currentLevel.name}</h2>
               <p className="text-xs text-slate-500 hidden md:block">{currentLevel.description}</p>
             </div>
          </div>
          <button onClick={resetGameFull} className="text-slate-400 hover:text-slate-600 flex items-center gap-1 text-sm bg-white px-3 py-1 rounded-full shadow-sm">
            <Home size={16} /> å›é¦–é 
          </button>
        </div>

        <div className="flex flex-col md:flex-row gap-8 w-full max-w-5xl flex-1">
          {/* Left: Map */}
          <div className="flex-1 bg-white p-6 rounded-3xl shadow-xl flex items-center justify-center min-h-[350px]">
            <div 
              className="grid gap-2 w-full max-w-[400px]"
              style={{ 
                gridTemplateColumns: `repeat(${currentLevel.gridSize}, minmax(0, 1fr))` 
              }}
            >
              {Array.from({ length: currentLevel.gridSize * currentLevel.gridSize }).map((_, i) => {
                const x = i % currentLevel.gridSize;
                const y = Math.floor(i / currentLevel.gridSize);
                const isWall = currentLevel.layout[y][x] === 1;
                const isGoal = x === currentLevel.goal.x && y === currentLevel.goal.y;
                const isRobot = x === robotState.x && y === robotState.y;

                return (
                  <div key={i} className={`
                    aspect-square rounded-xl flex items-center justify-center relative shadow-inner overflow-visible
                    ${isWall ? 'bg-slate-300' : 'bg-blue-50 border border-blue-100'}
                  `}>
                    {isWall && <div className="text-2xl md:text-3xl opacity-50">ğŸ§±</div>}
                    {isGoal && <Star className="w-8 h-8 md:w-10 md:h-10 text-yellow-400 fill-yellow-400 animate-pulse drop-shadow-lg" />}
                    
                    {isRobot && (
                      <div 
                        className="absolute w-4/5 h-4/5 transition-all duration-500 ease-in-out z-20 pointer-events-none"
                        style={{ 
                          top: '50%', 
                          left: '50%',
                          transform: `translate(-50%, -50%) rotate(${robotState.dir * 90}deg)`,
                          transformOrigin: 'center', 
                        }}
                      >
                          <RobotIcon 
                           className={`w-full h-full ${errorIndex !== -1 ? 'animate-shake' : ''}`} 
                           mood={errorIndex !== -1 ? "error" : "happy"} 
                          />
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          </div>

          {/* Right: Controls */}
          <div className="flex-1 flex flex-col gap-4">
            
            {/* Command Sequence Display */}
            <div className="bg-white p-4 rounded-2xl shadow-md min-h-[140px] flex flex-col">
              <h3 className="text-sm text-slate-400 font-bold mb-2 flex justify-between">
                <span>æŒ‡ä»¤åºåˆ—</span>
                <span className={`text-xs px-2 py-1 rounded font-bold ${commands.length >= currentLevel.maxCommands ? 'text-red-500 bg-red-100' : 'text-slate-500 bg-slate-100'}`}>
                  {commands.length} / {currentLevel.maxCommands}
                </span>
              </h3>
              <div className="flex gap-2 flex-wrap items-center content-start max-h-[160px] overflow-y-auto">
                {commands.map((cmd, idx) => {
                   const isCurrent = executionStep === idx;
                   const isError = errorIndex === idx;
                   return (
                    <div 
                      key={idx} 
                      onClick={() => removeCommand(idx)}
                      className={`
                        w-10 h-10 md:w-12 md:h-12 rounded-lg flex items-center justify-center text-lg font-bold border-b-2 md:border-b-4 cursor-pointer transition-all relative shrink-0
                        ${isCurrent ? 'scale-110 z-10 shadow-lg' : 'opacity-80 hover:opacity-100'}
                        ${isError ? 'bg-red-500 text-white border-red-700 ring-2 ring-red-300' : ''}
                        ${!isError && isCurrent ? 'ring-2 ring-yellow-400' : ''}
                        ${!isError && cmd === 'F' ? 'bg-blue-100 text-blue-600 border-blue-300' : ''}
                        ${!isError && cmd === 'L' ? 'bg-orange-100 text-orange-600 border-orange-300' : ''}
                        ${!isError && cmd === 'R' ? 'bg-green-100 text-green-600 border-green-300' : ''}
                      `}
                    >
                      {cmd === 'F' && <ArrowUp size={20} />}
                      {cmd === 'L' && <ArrowLeft size={20} />}
                      {cmd === 'R' && <ArrowRight size={20} />}
                      
                      <span className={`absolute -top-2 -right-2 w-4 h-4 text-[9px] rounded-full flex items-center justify-center border
                        ${isError ? 'bg-white text-red-600' : 'bg-slate-700 text-white'}
                      `}>
                        {idx + 1}
                      </span>
                    </div>
                  );
                })}
                {commands.length === 0 && (
                  <div className="w-full h-20 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center text-slate-400 text-sm">
                    é»æ“Šä¸‹æ–¹æŒ‰éˆ•åŠ å…¥æŒ‡ä»¤...
                  </div>
                )}
              </div>
              {errorIndex !== -1 && (
                <div className="mt-auto pt-2 text-red-500 font-bold text-sm flex items-center gap-1 animate-pulse">
                  <AlertCircle size={16} /> å“å‘€ï¼æ’åˆ°äº†ï¼
                </div>
              )}
            </div>

            {/* Input Buttons */}
            <div className="grid grid-cols-3 gap-3">
               <button 
                onClick={() => addCommand('L')}
                disabled={isAnimating}
                className="bg-orange-500 hover:bg-orange-400 disabled:opacity-50 text-white rounded-2xl p-3 md:p-4 shadow-[0_4px_0_rgb(194,65,12)] active:shadow-none active:translate-y-1 flex flex-col items-center gap-1 transition-all"
              >
                <ArrowLeft className="w-6 h-6 md:w-8 md:h-8" />
                <span className="font-bold text-xs md:text-sm">å·¦è½‰</span>
              </button>

              <button 
                onClick={() => addCommand('F')}
                disabled={isAnimating}
                className="bg-blue-500 hover:bg-blue-400 disabled:opacity-50 text-white rounded-2xl p-3 md:p-4 shadow-[0_4px_0_rgb(30,58,138)] active:shadow-none active:translate-y-1 flex flex-col items-center gap-1 transition-all"
              >
                <ArrowUp className="w-6 h-6 md:w-8 md:h-8" />
                <span className="font-bold text-xs md:text-sm">å‘å‰</span>
              </button>

              <button 
                onClick={() => addCommand('R')}
                disabled={isAnimating}
                className="bg-green-500 hover:bg-green-400 disabled:opacity-50 text-white rounded-2xl p-3 md:p-4 shadow-[0_4px_0_rgb(21,128,61)] active:shadow-none active:translate-y-1 flex flex-col items-center gap-1 transition-all"
              >
                <ArrowRight className="w-6 h-6 md:w-8 md:h-8" />
                <span className="font-bold text-xs md:text-sm">å³è½‰</span>
              </button>
            </div>

            {/* Action Buttons */}
            <div className="mt-auto flex gap-3">
              <button 
                onClick={resetLevel}
                disabled={isAnimating}
                className="flex-1 bg-slate-200 text-slate-600 font-bold py-4 rounded-xl hover:bg-slate-300 disabled:opacity-50 flex items-center justify-center gap-2"
              >
                <RotateCcw size={18} /> é‡ä¾†
              </button>
              <button 
                onClick={runSimulation}
                disabled={isAnimating || commands.length === 0}
                className="flex-[2] bg-yellow-400 text-blue-900 font-black text-xl py-4 rounded-xl shadow-[0_4px_0_rgb(180,83,9)] active:shadow-none active:translate-y-1 hover:bg-yellow-300 disabled:opacity-50 flex items-center justify-center gap-2"
              >
                <Play fill="currentColor" /> é–‹å§‹èµ°ï¼
              </button>
            </div>

          </div>
        </div>
      </div>
    );
  }

  // Page 4: Error
  if (page === 4) {
    return (
      <div className="min-h-screen bg-red-50 flex flex-col items-center justify-center p-4 text-center">
        <div className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full border-4 border-red-100">
          <RobotIcon className="w-32 h-32 mx-auto mb-6" mood="sad" />
          <h2 className="text-2xl font-bold text-red-600 mb-2">å“å‘€ï¼å¥½ç—›å–”ï¼</h2>
          <p className="text-slate-600 mb-8">
            æˆ‘æ’åˆ°ç‰†å£æˆ–æ˜¯è¿·è·¯äº†...<br/>
            æ‹œè¨—å¹«æˆ‘æª¢æŸ¥ç´…è‰²çš„æŒ‡ä»¤ï¼Œå†è©¦ä¸€æ¬¡ï¼
          </p>
          <button 
            onClick={() => { setPage(3); setRobotState(currentLevel.start); setExecutionStep(-1); setIsAnimating(false); setErrorIndex(-1); }}
            className="w-full py-3 bg-red-500 hover:bg-red-400 text-white font-bold rounded-xl shadow-lg flex items-center justify-center gap-2"
          >
            <RefreshCw size={20} /> å†è©¦ä¸€æ¬¡
          </button>
        </div>
      </div>
    );
  }

  // Page 5: Success
  if (page === 5) {
    return (
      <div className="min-h-screen bg-green-50 flex flex-col items-center justify-center p-4 text-center overflow-hidden">
        {/* Confetti Background Effect */}
        <div className="absolute inset-0 pointer-events-none opacity-30">
          {[...Array(20)].map((_, i) => (
            <div 
              key={i} 
              className="absolute w-4 h-4 rounded-full bg-yellow-400 animate-bounce"
              style={{
                left: `${Math.random() * 100}%`,
                top: `${Math.random() * 100}%`,
                animationDelay: `${Math.random()}s`,
                backgroundColor: ['#FBBF24', '#34D399', '#60A5FA', '#F472B6'][Math.floor(Math.random() * 4)]
              }}
            />
          ))}
        </div>

        <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-sm w-full relative z-10 border-4 border-green-200">
          <div className="mb-6">
            <RobotIcon className="w-40 h-40 mx-auto" mood="dance" />
          </div>
          <h2 className="text-3xl font-black text-green-600 mb-2">éé—œäº†ï¼</h2>
          <p className="text-slate-600 mb-8 font-medium">
            ä½ æˆåŠŸå®Œæˆäº† Level {currentLevel.id}ï¼<br/>
            {currentLevelIndex === 2 ? "ä½ å·²ç¶“é€šéäº†æ‰€æœ‰è€ƒé©—ï¼" : "æº–å‚™å¥½æ¥å—ä¸‹ä¸€å€‹æŒ‘æˆ°äº†å—ï¼Ÿ"}
          </p>
          <button 
            onClick={() => setPage(7)}
            className="w-full py-4 bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-300 hover:to-orange-300 text-white font-black text-xl rounded-xl shadow-lg transform hover:scale-105 transition-all flex items-center justify-center gap-2"
          >
            <Trophy fill="currentColor" /> é ˜å–è­‰æ›¸
          </button>
        </div>
      </div>
    );
  }

  // Page 7: Certificate
  if (page === 7) {
    return (
      <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 text-center relative overflow-hidden">
        {/* Shiny Background */}
        <div className="absolute inset-0 bg-gradient-to-b from-indigo-900 to-purple-900"></div>
        <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] opacity-30"></div>
        
        {/* Spotlight Effect */}
        <div className="absolute top-0 left-1/2 -translate-x-1/2 w-full h-1/2 bg-gradient-to-b from-yellow-300/20 to-transparent blur-3xl rounded-full pointer-events-none"></div>

        <div className="relative z-10 max-w-md w-full bg-white/10 backdrop-blur-lg border border-white/30 p-8 rounded-3xl shadow-2xl flex flex-col items-center">
          
          <div className="bg-yellow-400 text-blue-900 px-6 py-2 rounded-full font-bold mb-6 shadow-lg flex items-center gap-2">
            <Star fill="currentColor" size={16} /> æ­å–œå®Œæˆ Level {currentLevel.id} <Star fill="currentColor" size={16} />
          </div>

          <h1 className={`text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r mb-2 drop-shadow-sm ${currentLevel.certColor}`}>
            {currentLevel.certTitle}
          </h1>
          
          <div className="w-full h-1 bg-gradient-to-r from-transparent via-white/50 to-transparent my-6"></div>

          <p className="text-xl text-white font-medium mb-4">
            {SCHOOL_NAME}
          </p>
          
          <p className="text-blue-200 text-sm mb-8">
            åœ¨ <span className="text-white font-bold">{currentLevel.name}</span> å±•ç¾äº†è¶…å‡¡çš„æ™ºæ…§ï¼
          </p>

          <div className="bg-white/20 p-4 rounded-xl flex items-center gap-4 w-full mb-6">
            <div className="bg-white/20 p-3 rounded-full">
              <Camera className="text-white" size={24} />
            </div>
            <div className="text-left">
              <p className="text-white font-bold text-sm">è·Ÿæˆ‘åˆç…§</p>
              <p className="text-blue-200 text-xs">ç´€å¿µé€™ä¸€åˆ»çš„æ¦®è€€ï¼</p>
            </div>
          </div>
          
          <div className="flex gap-4 w-full">
            <button 
                onClick={resetGameFull}
                className="flex-1 py-3 text-white/70 hover:text-white text-sm bg-white/10 rounded-xl hover:bg-white/20 transition-all"
            >
                å›é¦–é 
            </button>
            
            {currentLevelIndex < LEVELS.length - 1 && (
                <button 
                    onClick={nextLevel}
                    className="flex-1 py-3 bg-yellow-500 hover:bg-yellow-400 text-blue-900 font-bold rounded-xl shadow-lg flex items-center justify-center gap-1"
                >
                    ä¸‹ä¸€é—œ <ChevronRight size={18} />
                </button>
            )}
          </div>
        </div>
      </div>
    );
  }

  return null;
}